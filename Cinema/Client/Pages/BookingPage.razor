@page "/booking/{ID}"
@using Cinema.Client.Dialogs.BookingDialogs
@using Cinema.Shared.DTO
@inject HttpClient Http
@inject IDialogService DialogService
@inject ISnackbar Snackbar

<PageTitle>Booking</PageTitle>

<MudContainer Class="mt-16 px-8" MaxWidth="MaxWidth.Medium">

    <MudPaper Class="justify-center align-content-center pa-10 ma-2" Elevation="1">

        <MudGrid Justify="Justify.Center" Spacing="5">
        
            @if (_ticketTypeBookings == null) 
            {
                <MudItem xs="12">
                    <TicketType OnSelectedTikcets="SelectedTickets" Availabletickets="_availableSeats"/>
                </MudItem>
            }
            else
            { 
                <MudItem xs="12">
                    <RoomLayout SeatScreenings="_seats" OnSeatsSelected="SelectedSeats" AmountOfSeatsSelected="_ticketTypeBookings.Count" />
                </MudItem>

                @if (_booking.SeatScreenings.Count > 0 && _booking.SeatScreenings.Count == _ticketTypeBookings.Count)
                {
                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.LocalMovies" Color="Color.Primary" OnClick="ConfirmBooking">Confirm Details</MudButton>
                }
                else
                {
                    <MudButton Variant="Variant.Filled" StartIcon="@Icons.Material.Filled.LocalMovies" Color="Color.Primary" Disabled OnClick="ConfirmBooking">Confirm Details</MudButton>
                }
            }
        
        </MudGrid>
    </MudPaper>

</MudContainer>


@code {
    private const string API_URL = "/api";
    private BookingDTO _booking;
    private ScreeningDTO _screening = new ScreeningDTO(); // FIX THIS
    private List<TicketTypeBookingDTO> _ticketTypeBookings;
    private List<SeatScreeningDTO> _seats;
    private int _availableSeats;

    [Parameter] public string ID { get; set; }

    protected override async Task OnInitializedAsync()
    {
        _booking = new BookingDTO();
        _booking.Status = "Pending";
        _booking.BookingRef = Convert.ToBase64String(Guid.NewGuid().ToByteArray()).Remove(0, 2); // This doesn't work
        
        _seats = await GetSeatScreenings();
        _availableSeats = _seats.Where(s => s.Booked != true).Select(s => s).Count();
    }

    protected async Task SelectedSeats(List<SeatScreeningDTO> seatScreenings)
    {
        _booking.SeatScreenings = seatScreenings;
    }

    protected async Task SelectedTickets(List<TicketTypeBookingDTO> ticketTypes)
    {
        _ticketTypeBookings = ticketTypes;
    }

    public async Task ConfirmBooking() 
    {
        var parameters = new DialogParameters();
        parameters.Add("Booking", _booking);
        parameters.Add("TicketTypeBooking", _ticketTypeBookings);
        parameters.Add("Screening", _screening);
        parameters.Add("Total", 19.99m); // GET THIS LEGIT

        DialogService.Show<BookingDialog>("Confirm Booking", parameters, new DialogOptions()
        {
            CloseButton = true,
            MaxWidth = MaxWidth.Medium,
            DisableBackdropClick = true,
            FullWidth = true
        });
    }

    public async Task<List<SeatScreeningDTO>> GetSeatScreenings() 
    {
        return await Http.GetFromJsonAsync<List<SeatScreeningDTO>>(API_URL + "/movie/seats/" + ID);
    }

}
